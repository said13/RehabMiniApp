# Таблицы БД (PostgreSQL): Конструктор видео-тренировок

> База проектируется под UUID-идентификаторы (генерируются автоматически), каскадное удаление дочерних сущностей и инварианты домена.

Состав:
- `categories` (категории)
- `trainings`  (тренировки)
- `complexes`  (комплексы внутри тренировки; без названия, только порядковый номер)
- `exercises`  (упражнения)

## Общие соглашения
- Все `id` — `UUID`, **autogenerated** (`DEFAULT uuid_generate_v4()`).
- Таймстемпы: `created_at`, `updated_at`; `updated_at` обновляется триггером.
- Связи: `ON DELETE CASCADE`.

---

## DDL (готово к применению)

```sql
-- UUID и updated_at
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE OR REPLACE FUNCTION set_updated_at() RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END; $$ LANGUAGE plpgsql;

-- 1) CATEGORIES
CREATE TABLE IF NOT EXISTS categories (
  id         UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title      TEXT NOT NULL,
  cover_url  TEXT NOT NULL,              -- URL обложки категории
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE TRIGGER trg_categories_upd
  BEFORE UPDATE ON categories
  FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 2) TRAININGS
CREATE TABLE IF NOT EXISTS trainings (
  id          UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  category_id UUID NOT NULL REFERENCES categories(id) ON DELETE CASCADE,
  title       TEXT NOT NULL,
  description TEXT NOT NULL,
  cover_url   TEXT NOT NULL,             -- URL обложки тренировки
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS trainings_category_idx ON trainings(category_id);
CREATE TRIGGER trg_trainings_upd
  BEFORE UPDATE ON trainings
  FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 3) COMPLEXES
CREATE TABLE IF NOT EXISTS complexes (
  id          UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  training_id UUID NOT NULL REFERENCES trainings(id) ON DELETE CASCADE,
  "order"     INT  NOT NULL,               -- порядковый номер (1..N)
  rounds      INT  NOT NULL CHECK (rounds >= 1),
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT complexes_order_unique UNIQUE (training_id, "order")
);
CREATE INDEX IF NOT EXISTS complexes_training_idx ON complexes(training_id);
CREATE TRIGGER trg_complexes_upd
  BEFORE UPDATE ON complexes
  FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 4) EXERCISES
CREATE TABLE IF NOT EXISTS exercises (
  id                    UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  complex_id            UUID NOT NULL REFERENCES complexes(id) ON DELETE CASCADE,
  title                 TEXT NOT NULL,
  video_url             TEXT,   -- хотя бы одно из video_url/mux_id должно быть заполнено
  mux_id                TEXT,
  video_duration_sec    INT  NOT NULL CHECK (video_duration_sec > 0),
  perform_duration_sec  INT  NOT NULL CHECK (perform_duration_sec > 0),
  repetitions           INT  CHECK (repetitions IS NULL OR repetitions > 0),
  rest_sec              INT  NOT NULL DEFAULT 0 CHECK (rest_sec >= 0),
  notes                 TEXT,
  created_at            TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at            TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT exercises_src_chk CHECK (video_url IS NOT NULL OR mux_id IS NOT NULL)
);
CREATE INDEX IF NOT EXISTS exercises_complex_idx ON exercises(complex_id);
CREATE TRIGGER trg_exercises_upd
  BEFORE UPDATE ON exercises
  FOR EACH ROW EXECUTE FUNCTION set_updated_at();
```
